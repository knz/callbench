CPPBENCH_DIR = ../../cppbench
CPPBENCH_DEPS = $(CPPBENCH_DIR)/bench.cc $(CPPBENCH_DIR)/bench.hh

CXXFLAGS = -std=c++17 -O3 -fomit-frame-pointer -fno-optimize-sibling-calls

PROGRAMS := nargs ret

all: $(PROGRAMS:%=%_cpp.log)

%_cpp.log: ./%
	./$* 2>&1 | tee $@.tmp
	mv -f $@.tmp $@

./%: %.cc autogenerated_%.cc $(CPPBENCH_DEPS)
	$(CXX) $(CXXFLAGS) -I$(CPPBENCH_DIR) $*.cc $(CPPBENCH_DIR)/bench.cc -o $@

autogenerated_%.cc: gen_%.sh
	bash gen_$*.sh >$@.tmp
	mv -f $@.tmp $@

clean:
	for i in nargs ret; do \
		rm -f $$i autogenerated_$$i.cc $$i.log; \
	done
	rm -f *\~ \#*
